<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>è¡¡é»å¥åº· â€” æœƒå“¡è³‡æ–™</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@300;400;600&family=DM+Serif+Display:ital@0;1&family=Noto+Sans+TC:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --white:      #ffffff;
    --gray:       #808080;
    --green:      #7ac19a;
    --green-lt:   #e2ede6;
    --green-dk:   #5f846f;
    --pink:       #f2ac98;
    --pink-lt:    #faece8;
    --pink-dk:    #c67566;
    --yellow:     #ffe08b;
    --yellow-lt:  #fcf4e3;
    --yellow-dk:  #ba9e60;
    --blue:       #9fcccc;
    --blue-lt:    #daedec;
    --blue-dk:    #66888e;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    min-height: 100vh;
    background: var(--green-lt);
    font-family: 'Noto Sans TC', sans-serif;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 24px 16px;
    position: relative;
    overflow-x: hidden;
  }

  /* Decorative blobs */
  body::before, body::after {
    content: '';
    position: fixed;
    border-radius: 50%;
    pointer-events: none;
    z-index: 0;
  }
  body::before {
    width: 480px; height: 480px;
    background: radial-gradient(circle, rgba(122,193,154,0.25) 0%, transparent 70%);
    top: -120px; right: -120px;
  }
  body::after {
    width: 380px; height: 380px;
    background: radial-gradient(circle, rgba(242,172,152,0.18) 0%, transparent 70%);
    bottom: -100px; left: -80px;
  }

  .card {
    background: var(--white);
    border-radius: 28px;
    width: 100%;
    max-width: 460px;
    padding: 48px 40px 44px;
    box-shadow:
      0 4px 24px rgba(95,132,111,0.10),
      0 1px 4px rgba(95,132,111,0.06);
    position: relative;
    z-index: 1;
    animation: slideUp 0.55s cubic-bezier(.22,.68,0,1.2) both;
  }

  @keyframes slideUp {
    from { opacity: 0; transform: translateY(32px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  /* Top accent bar */
  .card-accent {
    position: absolute;
    top: 0; left: 40px; right: 40px;
    height: 4px;
    background: linear-gradient(90deg, var(--green) 0%, var(--blue) 50%, var(--pink) 100%);
    border-radius: 0 0 4px 4px;
  }

  .logo-wrap {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 6px;
  }

  .logo-mark {
    width: 36px; height: 36px;
    background: linear-gradient(135deg, var(--green) 0%, var(--green-dk) 100%);
    border-radius: 10px;
    display: flex; align-items: center; justify-content: center;
    font-size: 18px;
    box-shadow: 0 2px 8px rgba(95,132,111,0.28);
  }

  .logo-text {
    font-family: 'Noto Serif TC', serif;
    font-weight: 600;
    font-size: 17px;
    color: var(--green-dk);
    letter-spacing: 2px;
  }

  .card-title {
    font-family: 'DM Serif Display', serif;
    font-size: 28px;
    color: #2d3e35;
    line-height: 1.2;
    margin-bottom: 4px;
    margin-top: 18px;
  }

  .card-sub {
    font-size: 13px;
    color: var(--gray);
    line-height: 1.6;
    margin-bottom: 32px;
  }

  /* Referrer pill */
  .ref-pill {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    background: var(--green-lt);
    border: 1px solid rgba(122,193,154,0.45);
    border-radius: 20px;
    padding: 5px 13px;
    font-size: 12px;
    color: var(--green-dk);
    margin-bottom: 28px;
    font-weight: 500;
    letter-spacing: 0.3px;
  }
  .ref-pill .dot {
    width: 7px; height: 7px;
    background: var(--green);
    border-radius: 50%;
    display: inline-block;
  }

  .form-group {
    margin-bottom: 20px;
    animation: fadeIn 0.5s ease both;
  }
  .form-group:nth-child(1) { animation-delay: 0.1s; }
  .form-group:nth-child(2) { animation-delay: 0.18s; }
  .form-group:nth-child(3) { animation-delay: 0.26s; }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  label {
    display: block;
    font-size: 12.5px;
    font-weight: 500;
    color: #4a5c52;
    margin-bottom: 7px;
    letter-spacing: 0.5px;
    text-transform: uppercase;
  }

  label .req {
    color: var(--pink-dk);
    margin-left: 2px;
  }

  .input-wrap {
    position: relative;
  }

  .input-icon {
    position: absolute;
    left: 14px; top: 50%;
    transform: translateY(-50%);
    font-size: 16px;
    pointer-events: none;
    opacity: 0.65;
  }

  input[type="text"],
  input[type="tel"] {
    width: 100%;
    padding: 13px 16px 13px 42px;
    border: 1.5px solid #d8e7df;
    border-radius: 12px;
    font-size: 15px;
    font-family: 'Noto Sans TC', sans-serif;
    color: #2d3e35;
    background: #fafcfb;
    outline: none;
    transition: border-color 0.2s, box-shadow 0.2s, background 0.2s;
  }

  input[type="text"]:focus,
  input[type="tel"]:focus {
    border-color: var(--green);
    background: var(--white);
    box-shadow: 0 0 0 3px rgba(122,193,154,0.18);
  }

  input[type="text"]::placeholder,
  input[type="tel"]::placeholder {
    color: #b5c9bf;
  }

  input.error {
    border-color: var(--pink-dk);
    box-shadow: 0 0 0 3px rgba(198,117,102,0.12);
  }

  .error-msg {
    font-size: 11.5px;
    color: var(--pink-dk);
    margin-top: 5px;
    padding-left: 4px;
    display: none;
  }
  .error-msg.show { display: block; }

  /* LINE hint */
  .line-hint {
    font-size: 12px;
    color: var(--blue-dk);
    margin-top: 6px;
    padding-left: 4px;
    display: flex;
    align-items: center;
    gap: 5px;
  }

  .divider {
    height: 1px;
    background: linear-gradient(90deg, transparent, #d8e7df 30%, #d8e7df 70%, transparent);
    margin: 28px 0;
  }

  .btn-submit {
    width: 100%;
    padding: 15px;
    background: linear-gradient(135deg, var(--green) 0%, var(--green-dk) 100%);
    color: var(--white);
    border: none;
    border-radius: 14px;
    font-size: 15.5px;
    font-family: 'Noto Sans TC', sans-serif;
    font-weight: 500;
    letter-spacing: 2px;
    cursor: pointer;
    transition: transform 0.15s, box-shadow 0.2s, filter 0.2s;
    box-shadow: 0 4px 16px rgba(95,132,111,0.35);
    position: relative;
    overflow: hidden;
  }

  .btn-submit::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, rgba(255,255,255,0.15) 0%, transparent 60%);
    pointer-events: none;
  }

  .btn-submit:hover {
    transform: translateY(-2px);
    box-shadow: 0 7px 22px rgba(95,132,111,0.40);
  }

  .btn-submit:active {
    transform: translateY(0);
    filter: brightness(0.95);
  }

  .btn-submit:disabled {
    opacity: 0.7;
    cursor: not-allowed;
    transform: none;
  }

  .btn-inner {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }

  /* â”€â”€ Confirmation Modal â”€â”€ */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(30,46,38,0.55);
    backdrop-filter: blur(4px);
    -webkit-backdrop-filter: blur(4px);
    z-index: 100;
    display: flex;
    align-items: flex-end;
    justify-content: center;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.25s ease;
  }
  .modal-overlay.show {
    opacity: 1;
    pointer-events: all;
  }
  .modal-sheet {
    background: var(--white);
    border-radius: 24px 24px 0 0;
    width: 100%;
    max-width: 480px;
    padding: 28px 28px 40px;
    transform: translateY(100%);
    transition: transform 0.35s cubic-bezier(.22,.68,0,1.1);
    box-shadow: 0 -8px 40px rgba(0,0,0,0.12);
  }
  .modal-overlay.show .modal-sheet {
    transform: translateY(0);
  }
  .modal-handle {
    width: 36px; height: 4px;
    background: #d8e7df;
    border-radius: 2px;
    margin: 0 auto 22px;
  }
  .modal-title {
    font-size: 17px; font-weight: 700;
    color: var(--ink);
    margin-bottom: 4px;
    text-align: center;
  }
  .modal-sub {
    font-size: 12.5px; color: var(--gray);
    text-align: center; margin-bottom: 22px;
  }
  .confirm-rows {
    background: var(--green-lt);
    border-radius: 14px;
    overflow: hidden;
    margin-bottom: 22px;
  }
  .confirm-row {
    display: flex; align-items: center; gap: 12px;
    padding: 13px 16px;
    border-bottom: 1px solid rgba(122,193,154,0.3);
  }
  .confirm-row:last-child { border-bottom: none; }
  .confirm-row-icon { font-size: 17px; width: 24px; text-align: center; flex-shrink: 0; }
  .confirm-row-label {
    font-size: 11.5px; color: var(--green-dk); font-weight: 600;
    width: 72px; flex-shrink: 0; letter-spacing: 0.3px;
  }
  .confirm-row-value {
    font-size: 14px; color: var(--ink); font-weight: 500;
    flex: 1; word-break: break-all;
  }
  .confirm-avatar {
    width: 30px; height: 30px; border-radius: 50%;
    object-fit: cover; border: 2px solid var(--green); flex-shrink: 0;
  }
  .modal-btns { display: flex; gap: 10px; }
  .btn-back {
    flex: 1; padding: 13px;
    background: var(--green-lt); color: var(--green-dk);
    border: 1.5px solid rgba(122,193,154,0.5);
    border-radius: 12px; font-size: 14.5px;
    font-family: 'Noto Sans TC', sans-serif; font-weight: 500;
    cursor: pointer; transition: background 0.15s;
  }
  .btn-back:hover { background: #cee5d8; }
  .btn-confirm {
    flex: 2; padding: 13px;
    background: linear-gradient(135deg, var(--green) 0%, var(--green-dk) 100%);
    color: var(--white); border: none; border-radius: 12px;
    font-size: 14.5px; font-family: 'Noto Sans TC', sans-serif;
    font-weight: 500; letter-spacing: 1.5px; cursor: pointer;
    transition: transform 0.15s, box-shadow 0.2s;
    box-shadow: 0 3px 12px rgba(95,132,111,0.35);
    display: flex; align-items: center; justify-content: center; gap: 8px;
  }
  .btn-confirm:hover { transform: translateY(-1px); box-shadow: 0 5px 18px rgba(95,132,111,0.4); }
  .btn-confirm:disabled { opacity: 0.7; cursor: not-allowed; transform: none; }

  /* Success state */
  .success-panel {
    display: none;
    text-align: center;
    padding: 20px 0;
    animation: slideUp 0.5s cubic-bezier(.22,.68,0,1.2) both;
  }

  .success-icon {
    width: 72px; height: 72px;
    background: linear-gradient(135deg, var(--green-lt), var(--green));
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 32px;
    margin: 0 auto 20px;
    box-shadow: 0 4px 20px rgba(122,193,154,0.35);
  }

  .success-title {
    font-family: 'Noto Serif TC', serif;
    font-size: 22px;
    color: var(--green-dk);
    margin-bottom: 10px;
    font-weight: 600;
  }

  .success-sub {
    font-size: 14px;
    color: var(--gray);
    line-height: 1.7;
  }

  .success-data {
    background: var(--green-lt);
    border-radius: 14px;
    padding: 16px 20px;
    margin-top: 20px;
    text-align: left;
  }

  .success-data-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 6px 0;
    font-size: 13.5px;
    border-bottom: 1px dashed rgba(122,193,154,0.4);
  }
  .success-data-row:last-child { border-bottom: none; }
  .success-data-row span:first-child { color: var(--green-dk); font-weight: 500; }
  .success-data-row span:last-child  { color: #2d3e35; }

  /* Hidden debug panel */
  .debug-panel {
    position: fixed;
    bottom: 16px; right: 16px;
    background: rgba(45,62,53,0.92);
    color: #7ac19a;
    font-family: monospace;
    font-size: 11px;
    padding: 12px 16px;
    border-radius: 10px;
    max-width: 280px;
    z-index: 100;
    display: none;
    line-height: 1.7;
    backdrop-filter: blur(6px);
  }
  .debug-panel.show { display: block; }
  .debug-panel strong { color: #ffe08b; }

  /* LINE status badge */
  .line-status {
    display: none;
    align-items: center;
    gap: 10px;
    background: var(--green-lt);
    border: 1px solid rgba(122,193,154,0.4);
    border-radius: 14px;
    padding: 12px 16px;
    margin-bottom: 4px;
    font-size: 13.5px;
    color: var(--green-dk);
    min-height: 52px;
    animation: fadeIn 0.4s ease both;
  }
  .line-status.error {
    display: flex;
    background: var(--pink-lt);
    border-color: rgba(198,117,102,0.4);
    color: var(--pink-dk);
  }
  .line-avatar {
    width: 36px; height: 36px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid var(--green);
    flex-shrink: 0;
  }
  .line-info { flex: 1; }
  .line-display-name { font-weight: 500; color: #2d3e35; }
  .line-uid { font-size: 11px; color: var(--gray); margin-top: 2px; font-family: monospace; }
  .line-check { font-size: 18px; }

  /* Loading spinner */
  .spinner {
    width: 18px; height: 18px;
    border: 2.5px solid rgba(255,255,255,0.35);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 0.7s linear infinite;
    display: none;
  }
  .spinning .spinner { display: inline-block; }
  .spinning .btn-label { display: none; }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* Scrollbar */
  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: var(--green-lt); }
  ::-webkit-scrollbar-thumb { background: var(--green); border-radius: 3px; }

  @media (max-width: 480px) {
    .card { padding: 32px 20px 28px; border-radius: 20px; }
    .card-title { font-size: 22px; }
    .modal-sheet { padding: 24px 20px 32px; }
  }

  /* Tablet */
  @media (min-width: 481px) and (max-width: 768px) {
    .card { max-width: 500px; padding: 44px 36px 40px; }
  }

  /* Desktop â€” ç½®ä¸­å¡ç‰‡ï¼ŒåŠ å¤§å…§è·èˆ‡å­—é«” */
  @media (min-width: 769px) {
    body { padding: 48px 24px; align-items: center; }
    .card {
      max-width: 520px;
      padding: 56px 52px 52px;
      border-radius: 32px;
    }
    .card-title { font-size: 30px; }
    .logo-text  { font-size: 18px; }
    input[type="text"],
    input[type="tel"] { font-size: 16px; padding: 14px 18px 14px 46px; }
    .btn-submit { font-size: 16px; padding: 16px; }
    .modal-sheet {
      /* æ¡Œæ©Ÿæ”¹ç‚ºç½®ä¸­å½ˆçª—ï¼Œä¸è²¼åº•éƒ¨ */
      border-radius: 20px;
      max-width: 420px;
      margin-bottom: 0;
      padding: 32px 32px 36px;
    }
    .modal-overlay {
      align-items: center;
    }
    .modal-overlay.show .modal-sheet {
      transform: translateY(0) scale(1);
    }
    /* æ¡Œæ©Ÿé€²å ´å‹•ç•«æ”¹ç‚ºç¸®æ”¾ */
    .modal-sheet {
      transform: scale(0.92);
      transition: transform 0.3s cubic-bezier(.22,.68,0,1.15), opacity 0.25s ease;
      opacity: 0;
    }
    .modal-overlay.show .modal-sheet {
      transform: scale(1);
      opacity: 1;
    }
  }

  /* â”€â”€ Disease section â”€â”€ */
  .disease-section {
    margin-top: 22px;
    animation: fadeIn 0.5s ease both;
    animation-delay: 0.26s;
  }
  .disease-section-label {
    display: block;
    font-size: 12.5px;
    font-weight: 500;
    color: #4a5c52;
    margin-bottom: 7px;
    letter-spacing: 0.5px;
    text-transform: uppercase;
  }
  .disease-section-label .req { color: var(--pink-dk); margin-left: 2px; }
  .disease-warn {
    font-size: 12px;
    color: var(--pink-dk);
    line-height: 1.6;
    margin-bottom: 12px;
    padding: 10px 13px;
    background: var(--pink-lt);
    border-left: 3px solid var(--pink);
    border-radius: 8px;
  }
  .disease-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
    margin-bottom: 10px;
  }
  .disease-item {
    display: flex;
    align-items: center;
    gap: 9px;
    background: #fafcfb;
    border: 1.5px solid #d8e7df;
    border-radius: 10px;
    padding: 10px 12px;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 13.5px;
    color: #2d3e35;
    min-height: 44px;
    -webkit-tap-highlight-color: transparent;
  }
  .disease-item:active { transform: scale(0.97); }
  .disease-item input[type="checkbox"] {
    width: 17px; height: 17px;
    accent-color: var(--green-dk);
    flex-shrink: 0;
    cursor: pointer;
  }
  .disease-item.selected {
    background: var(--green-lt);
    border-color: var(--green);
    color: var(--green-dk);
    font-weight: 600;
  }
  .disease-item-full {
    grid-column: 1 / -1;
    flex-direction: column;
    align-items: flex-start;
    gap: 0;
  }
  .disease-item-full .disease-item-row {
    display: flex; align-items: center; gap: 9px; width: 100%;
  }
  .disease-item-full input[type="text"] {
    width: 100%;
    margin-top: 8px;
    padding: 9px 12px;
    border: 1.5px solid #d8e7df;
    border-radius: 8px;
    font-size: 13px;
    font-family: 'Noto Sans TC', sans-serif;
    color: #2d3e35;
    background: var(--white);
    outline: none;
    transition: border-color 0.2s, box-shadow 0.2s;
  }
  .disease-item-full input[type="text"]:focus {
    border-color: var(--green);
    box-shadow: 0 0 0 3px rgba(122,193,154,0.15);
  }
  .disease-agree {
    display: flex;
    align-items: flex-start;
    gap: 10px;
    padding: 12px 14px;
    background: var(--pink-lt);
    border: 1.5px solid rgba(242,172,152,0.6);
    border-radius: 12px;
    cursor: pointer;
    margin-top: 12px;
    font-size: 13px;
    color: var(--green-dk);
    line-height: 1.6;
    -webkit-tap-highlight-color: transparent;
  }
  .disease-agree input[type="checkbox"] {
    width: 17px; height: 17px;
    accent-color: var(--pink-dk);
    flex-shrink: 0;
    margin-top: 2px;
    cursor: pointer;
  }
  .error-msg.disease-err { margin-top: 8px; }


  /* â”€â”€ Already submitted panel â”€â”€ */
  .already-panel {
    display: none;
    padding: 10px 0 20px;
    animation: slideUp 0.5s cubic-bezier(.22,.68,0,1.2) both;
  }
  .already-icon {
    width: 68px; height: 68px;
    background: linear-gradient(135deg, var(--blue-lt), var(--blue));
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 30px;
    margin: 0 auto 20px;
    box-shadow: 0 4px 16px rgba(159,204,204,0.35);
  }
  .already-title {
    font-size: 20px; font-weight: 700;
    color: var(--ink); text-align: center; margin-bottom: 6px;
  }
  .already-sub {
    font-size: 13px; color: var(--gray);
    text-align: center; line-height: 1.7; margin-bottom: 24px;
  }
  .already-data {
    background: var(--green-lt);
    border: 1.5px solid rgba(122,193,154,0.4);
    border-radius: 16px;
    overflow: hidden;
    margin-bottom: 20px;
  }
  .already-row {
    display: flex; align-items: flex-start; gap: 10px;
    padding: 12px 16px;
    border-bottom: 1px solid rgba(122,193,154,0.25);
    font-size: 13.5px;
  }
  .already-row:last-child { border-bottom: none; }
  .already-row-label {
    color: var(--green-dk); font-weight: 600;
    width: 72px; flex-shrink: 0; font-size: 12.5px; padding-top: 1px;
  }
  .already-row-value {
    color: var(--ink); flex: 1; line-height: 1.6; word-break: break-word;
  }
  .already-contact {
    background: var(--yellow-lt);
    border: 1.5px solid rgba(255,224,139,0.7);
    border-radius: 14px;
    padding: 14px 16px;
    font-size: 13px; color: #5a4a1a; line-height: 1.7;
    text-align: center;
  }
  .already-contact strong { color: var(--yellow-dk); display: block; margin-bottom: 4px; font-size: 13.5px; }

</style>
</head>
<body>

<div class="card">
  <div class="card-accent"></div>

  <div class="logo-wrap">
    <div class="logo-mark">ğŸŒ¿</div>
    <span class="logo-text">è¡¡é»å¥åº·</span>
  </div>

  <!-- Referrer pill (filled by JS) -->
  <div class="ref-pill" id="refPill" style="display:none;">
    <span class="dot"></span>
    <span id="refText"></span>
  </div>

  <!-- Form area -->
  <div id="formArea">
    <h1 class="card-title">æœƒå“¡è³‡æ–™</h1>
    <p class="card-sub">å¡«å¯«ä»¥ä¸‹è³‡æ–™ï¼Œè®“æˆ‘å€‘ç‚ºæ‚¨æä¾›æ›´å€‹äººåŒ–çš„æœå‹™é«”é©— âœ¨</p>

    <form id="bindForm" novalidate>

      <div class="form-group">
        <label>å§“å <span class="req">*</span></label>
        <div class="input-wrap">
          <span class="input-icon">ğŸ‘¤</span>
          <input type="text" id="name" placeholder="è«‹è¼¸å…¥æ‚¨çš„å§“å" autocomplete="name">
        </div>
        <div class="error-msg" id="nameErr">è«‹å¡«å¯«å§“å</div>
      </div>

      <div class="form-group">
        <label>æ‰‹æ©Ÿè™Ÿç¢¼ <span class="req">*</span></label>
        <div class="input-wrap">
          <span class="input-icon">ğŸ“±</span>
          <input type="tel" id="phone" placeholder="09xxxxxxxx" autocomplete="tel" maxlength="13">
        </div>
        <div class="error-msg" id="phoneErr">è«‹å¡«å¯«æœ‰æ•ˆçš„æ‰‹æ©Ÿè™Ÿç¢¼ï¼ˆ09 é–‹é ­ 10 ç¢¼ï¼‰</div>
      </div>


      <!-- ç–¾ç—…å² -->
      <div class="disease-section">
        <span class="disease-section-label">ç–¾ç—…å² <span class="req">*</span></span>
        <div class="disease-warn">è«‹æ›´æ–°æ‚¨çš„ç–¾ç—…å²ï¼Œç¢ºä¿å ´é¤¨æŒæ¡æœ€æ–°å¥åº·ç‹€æ³ã€‚</div>

        <div class="disease-grid">
          <label class="disease-item"><input type="checkbox" name="disease" value="å¿ƒè‡Ÿç—…"><span>å¿ƒè‡Ÿç—…</span></label>
          <label class="disease-item"><input type="checkbox" name="disease" value="å¿ƒçµç—›"><span>å¿ƒçµç—›</span></label>
          <label class="disease-item"><input type="checkbox" name="disease" value="ç³–å°¿ç—…"><span>ç³–å°¿ç—…</span></label>
          <label class="disease-item"><input type="checkbox" name="disease" value="ç–æ°£/è„«è…¸"><span>ç–æ°£/è„«è…¸</span></label>
          <label class="disease-item"><input type="checkbox" name="disease" value="é«˜è¡€å£“"><span>é«˜è¡€å£“</span></label>
          <label class="disease-item"><input type="checkbox" name="disease" value="æ°£å–˜"><span>æ°£å–˜</span></label>
          <label class="disease-item"><input type="checkbox" name="disease" value="è²§è¡€"><span>è²§è¡€</span></label>
          <label class="disease-item"><input type="checkbox" name="disease" value="ç™²ç™‡"><span>ç™²ç™‡</span></label>
          <label class="disease-item"><input type="checkbox" name="disease" value="ç”²ç‹€è…ºå•é¡Œ"><span>ç”²ç‹€è…ºå•é¡Œ</span></label>
          <label class="disease-item"><input type="checkbox" name="disease" value="éœè„ˆç˜¤"><span>éœè„ˆç˜¤</span></label>
          <label class="disease-item"><input type="checkbox" name="disease" value="æƒ¡æ€§è…«ç˜¤"><span>æƒ¡æ€§è…«ç˜¤</span></label>
          <label class="disease-item"><input type="checkbox" name="disease" value="æ¤é–“ç›¤çªå‡º"><span>æ¤é–“ç›¤çªå‡º</span></label>
          <label class="disease-item"><input type="checkbox" name="disease" value="ç¿’æ…£æ€§è„«è‡¼"><span>ç¿’æ…£æ€§è„«è‡¼</span></label>
          <label class="disease-item"><input type="checkbox" name="disease" value="è„Šæ¤æ»‘è„«"><span>è„Šæ¤æ»‘è„«</span></label>
          <label class="disease-item"><input type="checkbox" name="disease" value="éª¨è³ªç–é¬†ç—‡"><span>éª¨è³ªç–é¬†ç—‡</span></label>
          <label class="disease-item"><input type="checkbox" name="disease" value="ç—›é¢¨/é¢¨æ¿•"><span>ç—›é¢¨/é¢¨æ¿•</span></label>

          <!-- é—œç¯€å•é¡Œï¼ˆå«è©³ç´°æ¬„ï¼‰ -->
          <label class="disease-item disease-item-full" id="jointLabel">
            <div class="disease-item-row">
              <input type="checkbox" name="disease" value="é—œç¯€å•é¡Œ" id="diseaseJoint">
              <span>é—œç¯€å•é¡Œ</span>
            </div>
            <input type="text" id="jointDetail" placeholder="ä¾‹å¦‚ï¼šå³è†é—œç¯€ç–¼ç—›3å€‹æœˆ" style="display:none;">
          </label>

          <!-- è„Šæ¤å•é¡Œï¼ˆå«è©³ç´°æ¬„ï¼‰ -->
          <label class="disease-item disease-item-full" id="spineLabel">
            <div class="disease-item-row">
              <input type="checkbox" name="disease" value="è„Šæ¤å•é¡Œ" id="diseaseSpine">
              <span>è„Šæ¤å•é¡Œ</span>
            </div>
            <input type="text" id="spineDetail" placeholder="ä¾‹å¦‚ï¼šè…°æ¤è¼•å¾®çªå‡º" style="display:none;">
          </label>

          <!-- å…¶ä»–ï¼ˆå«è©³ç´°æ¬„ï¼‰ -->
          <label class="disease-item disease-item-full" id="otherDiseaseLabel">
            <div class="disease-item-row">
              <input type="checkbox" name="disease" value="å…¶ä»–" id="diseaseOther">
              <span>å…¶ä»–</span>
            </div>
            <input type="text" id="otherDetail" placeholder="ä¾‹å¦‚ï¼šåé ­ç—›ã€é¼»ç‚ç­‰" style="display:none;">
          </label>

          <!-- ç„¡ -->
          <label class="disease-item" id="noDiseaseLabel">
            <input type="checkbox" name="disease" value="ç„¡" id="diseaseNone">
            <span>ç„¡</span>
          </label>
        </div>

        <!-- åŒæ„è²æ˜ -->
        <label class="disease-agree">
          <input type="checkbox" id="diseaseAgree">
          <span>åŒæ„ä»¥ä¸Šå…§å®¹å‡ç‚ºå±¬å¯¦å¡«å¯«ï¼Œ<br>å¦‚å¾ŒçºŒæœ‰ç™¼ç”Ÿä»¥ä¸Šç‹€æ³éœ€å„ªå…ˆå‘ŠçŸ¥æ•™ç·´</span>
        </label>
        <div class="error-msg disease-err" id="diseaseErr" style="display:none;">è«‹è‡³å°‘é¸æ“‡ä¸€é …ä¸¦å‹¾é¸åŒæ„è²æ˜</div>
      </div>

      <!-- LINE è³‡è¨Šç”± LIFF è‡ªå‹•å–å¾—ï¼Œä¸é¡¯ç¤ºæ¬„ä½ -->
      <div class="line-status" id="lineStatus"></div>

      <div class="divider"></div>

      <button type="submit" class="btn-submit" id="submitBtn">
        <div class="btn-inner">
          <div class="spinner"></div>
          <span class="btn-label">ç¢ºèªé€å‡º</span>
        </div>
      </button>

    </form>
  </div>


  <!-- Already submitted area -->
  <div class="already-panel" id="alreadyArea">
    <div class="already-icon">ğŸ“‹</div>
    <div class="already-title">æ‚¨å·²å¡«å¯«éè³‡æ–™</div>
    <div class="already-sub">ä»¥ä¸‹ç‚ºæäº¤çš„å…§å®¹</div>
    <div class="already-data" id="alreadyData"></div>
    <div class="already-contact">
      <strong>éœ€è¦ä¿®æ”¹è³‡æ–™ï¼Ÿ</strong>
      è«‹é€éå®˜æ–¹ LINE è¯ç¹«æˆ‘å€‘ï¼Œ<br>æˆ‘å€‘å°‡å”åŠ©æ‚¨æ›´æ–°è³‡æ–™ ğŸ’¬
    </div>
  </div>

  <!-- Success area -->
  <div class="success-panel" id="successArea">
    <div class="success-icon">âœ…</div>
    <div class="success-title">é€å‡ºå®Œæˆï¼</div>
    <div class="success-sub">æ‚¨çš„è³‡æ–™å·²æˆåŠŸé€å‡º</div>
    <div class="success-data" id="successData"></div>
  </div>
</div>

<!-- Dev debug panel (show with ?debug=1) -->
<div class="debug-panel" id="debugPanel">
  <strong>ğŸ”§ URL åƒæ•¸åµæ¸¬</strong><br>
  <div id="debugContent"></div>
</div>


<!-- â”€â”€ Confirmation Modal â”€â”€ -->
<div class="modal-overlay" id="confirmModal">
  <div class="modal-sheet" id="confirmSheet">
    <div class="modal-handle"></div>
    <div class="modal-title">ç¢ºèªé€å‡ºè³‡æ–™</div>
    <div class="modal-sub">è«‹ç¢ºèªä»¥ä¸‹è³‡æ–™ç„¡èª¤å¾Œé€å‡º</div>
    <div class="confirm-rows" id="confirmRows"></div>
    <div class="modal-btns">
      <button class="btn-back" id="btnBack">â† è¿”å›ä¿®æ”¹</button>
      <button class="btn-confirm" id="btnConfirm">
        <div class="spinner" id="confirmSpinner"></div>
        <span id="confirmLabel">ç¢ºèªé€å‡º</span>
      </button>
    </div>
  </div>
</div>

<script>
// â”€â”€â”€ è¨­å®šå€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const LIFF_ID      = '2008660081-1iUXNzEu';                        // â† å¡«å…¥ä½ çš„ LIFF ID
const WEBHOOK_URL  = 'https://hook.us2.make.com/g9cnxw761cm8pit6iqxiggniuxb9ywb9'; // â† å¡«å…¥ Make Webhook

// â”€â”€â”€ 1. Parse URL parameters â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const params  = new URLSearchParams(window.location.search);
const refBy   = params.get('ref')   || '';
const refName = params.get('name')  || '';
const source  = params.get('src')   || '';
const cid     = params.get('cid')   || '';
const debug   = params.get('debug') === '1';

// LINE profile (å¡«å…¥å¾Œæ‰å¯é€å‡º)
let lineProfile = null;

// â”€â”€â”€ 2. Show referrer pill â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if (refName || refBy) {
  const pill = document.getElementById('refPill');
  pill.style.display = 'inline-flex';
  document.getElementById('refText').textContent = refName
    ? `ç”± ${refName} é‚€è«‹å¡«å¯«`
    : `é‚€è«‹ç¢¼ï¼š${refBy}`;
}

// â”€â”€â”€ 3. Debug panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if (debug) {
  document.getElementById('debugPanel').classList.add('show');
}

function updateDebug(extra = {}) {
  if (!debug) return;
  const all = { ref: refBy, ref_name: refName, src: source, cid, ...extra };
  document.getElementById('debugContent').innerHTML =
    Object.entries(all).map(([k,v]) =>
      `${k}: <strong>${v || 'â€”'}</strong>`
    ).join('<br>');
}
updateDebug();

// â”€â”€â”€ 4. LIFF Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const statusEl = document.getElementById('lineStatus');

function setStatus(html, type = '') {
  statusEl.className = 'line-status' + (type ? ' ' + type : '');
  statusEl.innerHTML = html;
}

setStatus('', ''); // èƒŒæ™¯éœé»˜é©—è­‰ï¼Œä¸é¡¯ç¤ºä»»ä½•ç‹€æ…‹

liff.init({ liffId: LIFF_ID })
  .then(async () => {
    if (!liff.isLoggedIn()) {
      liff.login({ redirectUri: location.href });
      return;
    }
    const profile = await liff.getProfile();
    lineProfile = profile;

    updateDebug({
      lineUserId: profile.userId,
      displayName: profile.displayName,
    });

    // â”€â”€ æª¢æŸ¥æ˜¯å¦å·²æœ‰è³‡æ–™ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    await checkExistingData(profile.userId);
  })
  .catch(err => {
    console.error('LIFF init failed:', err);
    setStatus('âš ï¸ LINE é©—è­‰å¤±æ•—ï¼Œè«‹é€é LINE é–‹å•Ÿæ­¤é é¢', 'error');
    document.getElementById('submitBtn').disabled = true;
  });

// â”€â”€â”€ æª¢æŸ¥æš«å­˜è¡¨æ˜¯å¦å·²æœ‰æ­¤ LINE ID â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function checkExistingData(lineUserId) {
  try {
    const res = await fetch(WEBHOOK_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: 'check', line_user_id: lineUserId }),
    });
    if (!res.ok) return;

    // å®‰å…¨è§£æï¼Œé¿å… Make å›å‚³éæ¨™æº– JSON æ™‚ç‚¸æ‰
    const text = await res.text();
    let result;
    try {
      result = JSON.parse(text);
    } catch (e) {
      console.warn('Make å›å‚³é JSONï¼Œè¦–ç‚ºå°šæœªå¡«å¯«:', text);
      return;
    }

    if (result && result.found === true) {
      showAlreadyPanel(result);
    }
  } catch (err) {
    console.warn('check å¤±æ•—ï¼Œç¹¼çºŒé¡¯ç¤ºè¡¨å–®:', err);
  }
}

// â”€â”€â”€ é¡¯ç¤ºã€Œå·²å¡«å¯«ã€ç•«é¢ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showAlreadyPanel(data) {
  document.getElementById('formArea').style.display = 'none';

  const rows = [
    ['å§“å',     data.name     || 'â€”'],
    ['æ‰‹æ©Ÿ',     data.phone    || 'â€”'],
    ['LINE æš±ç¨±', data.line_display_name || 'â€”'],
  ];

  // ç–¾ç—…å²å–®ç¨è™•ç†ï¼Œæ ¼å¼åŒ–æˆç·¨è™Ÿåˆ—è¡¨
  const diseasesHtml = data.diseases
    ? data.diseases.split('ã€').map((d, i) =>
        `<div style="display:flex;gap:8px;padding:4px 0;">
           <span style="color:var(--green-dk);font-weight:700;flex-shrink:0;min-width:20px;">${i+1}.</span>
           <span>${escHtml(d.trim())}</span>
         </div>`
      ).join('')
    : 'â€”';

  document.getElementById('alreadyData').innerHTML =
    rows.map(([label, val]) => `
      <div class="already-row">
        <span class="already-row-label">${escHtml(label)}</span>
        <span class="already-row-value">${escHtml(String(val))}</span>
      </div>
    `).join('') +
    `<div class="already-row" style="align-items:flex-start;">
       <span class="already-row-label">ç–¾ç—…å²</span>
       <span class="already-row-value">${diseasesHtml}</span>
     </div>`;

  const panel = document.getElementById('alreadyArea');
  panel.style.display = 'block';
}

// â”€â”€â”€ 5. Validation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showError(inputId, errId, show) {
  document.getElementById(inputId).classList.toggle('error', show);
  document.getElementById(errId).classList.toggle('show', show);
}

function validateForm() {
  let ok = true;
  const name  = document.getElementById('name').value.trim();
  const phone = document.getElementById('phone').value.trim();

  if (!name) { showError('name','nameErr',true);  ok = false; }
  else         showError('name','nameErr',false);

  if (!phone || !/^09\d{2}-\d{3}-\d{3}$/.test(phone)) { showError('phone','phoneErr',true);  ok = false; }
  else                                       showError('phone','phoneErr',false);

  // Disease validation
  var checkedDiseases = document.querySelectorAll('input[name="disease"]:checked');
  var diseaseAgree    = document.getElementById('diseaseAgree');
  var diseaseErr      = document.getElementById('diseaseErr');
  var diseaseOk = checkedDiseases.length > 0 && diseaseAgree.checked;

  // Check detail fields
  if (document.getElementById('diseaseJoint').checked && !document.getElementById('jointDetail').value.trim()) diseaseOk = false;
  if (document.getElementById('diseaseSpine').checked && !document.getElementById('spineDetail').value.trim()) diseaseOk = false;
  if (document.getElementById('diseaseOther').checked && !document.getElementById('otherDetail').value.trim())  diseaseOk = false;

  if (!diseaseOk) {
    diseaseErr.style.display = 'block';
    if (checkedDiseases.length === 0)       diseaseErr.textContent = 'è«‹è‡³å°‘é¸æ“‡ä¸€é …ç–¾ç—…å²';
    else if (!diseaseAgree.checked)          diseaseErr.textContent = 'è«‹å‹¾é¸åŒæ„è²æ˜';
    else                                     diseaseErr.textContent = 'è«‹å¡«å¯«è©³ç´°èªªæ˜';
    ok = false;
  } else {
    diseaseErr.style.display = 'none';
  }

  return ok;
}

['name'].forEach(id => {
  document.getElementById(id).addEventListener('input', validateForm);
});

// â”€â”€ æ‰‹æ©Ÿè™Ÿç¢¼ï¼šåªå…è¨±æ•¸å­—ã€è‡ªå‹•åŠ ç ´æŠ˜è™Ÿã€é™åˆ¶ 10 ç¢¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('phone').addEventListener('input', function () {
  const cursor   = this.selectionStart;
  const before   = this.value;

  // 1. åªå–æ•¸å­—ï¼Œæœ€å¤š 10 ç¢¼
  const digits = before.replace(/\D/g, '').slice(0, 10);

  // 2. åŠ ç ´æŠ˜è™Ÿ
  let formatted = digits;
  if (digits.length > 7)      formatted = `${digits.slice(0,4)}-${digits.slice(4,7)}-${digits.slice(7)}`;
  else if (digits.length > 4) formatted = `${digits.slice(0,4)}-${digits.slice(4)}`;

  // 3. æ›´æ–°è¼¸å…¥æ¡†ï¼ˆé¿å…ä¸å¿…è¦çš„é‡ç¹ªï¼‰
  if (this.value !== formatted) {
    // è£œå„Ÿæ¸¸æ¨™ä½ç§»ï¼ˆç ´æŠ˜è™Ÿæ’å…¥æ™‚å¾€å¾ŒæŒªä¸€æ ¼ï¼‰
    const added = formatted.length - before.length;
    this.value = formatted;
    const newCursor = Math.max(0, cursor + added);
    this.setSelectionRange(newCursor, newCursor);
  }

  validateForm();
});

// â”€â”€â”€ 6. Submit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â”€â”€â”€ 6. Form submit â†’ é–‹å•Ÿç¢ºèª Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('bindForm').addEventListener('submit', (e) => {
  e.preventDefault();
  if (!validateForm()) return;
  if (!lineProfile) {
    setStatus('âš ï¸ å°šæœªå–å¾— LINE è³‡è¨Šï¼Œè«‹ç¨å€™å†è©¦', 'error');
    return;
  }
  openConfirmModal();
});

// â”€â”€â”€ ç¢ºèª Modal é‚è¼¯ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openConfirmModal() {
  const name  = document.getElementById('name').value.trim();
  const phone = formatPhone(document.getElementById('phone').value.trim());

  const diseaseList = Array.from(document.querySelectorAll('input[name="disease"]:checked')).map(cb => {
    if (cb.id === 'diseaseJoint') return 'é—œç¯€å•é¡Œ: ' + document.getElementById('jointDetail').value.trim();
    if (cb.id === 'diseaseSpine') return 'è„Šæ¤å•é¡Œ: ' + document.getElementById('spineDetail').value.trim();
    if (cb.id === 'diseaseOther') return 'å…¶ä»–: '    + document.getElementById('otherDetail').value.trim();
    return cb.value;
  });

  const diseasesHtml = diseaseList.length
    ? diseaseList.map((d, i) =>
        `<div style="display:flex;gap:8px;padding:4px 0;">
           <span style="color:var(--green-dk);font-weight:700;flex-shrink:0;min-width:20px;">${i+1}.</span>
           <span>${escHtml(d.trim())}</span>
         </div>`
      ).join('')
    : 'æœªå¡«å¯«';

  document.getElementById('confirmRows').innerHTML = `
    <div class="confirm-row">
      <span class="confirm-row-icon">ğŸ‘¤</span>
      <span class="confirm-row-label">å§“å</span>
      <span class="confirm-row-value">${escHtml(name)}</span>
    </div>
    <div class="confirm-row">
      <span class="confirm-row-icon">ğŸ“±</span>
      <span class="confirm-row-label">æ‰‹æ©Ÿ</span>
      <span class="confirm-row-value">${escHtml(phone)}</span>
    </div>
    <div class="confirm-row" style="align-items:flex-start;">
      <span class="confirm-row-icon">ğŸ¥</span>
      <span class="confirm-row-label">ç–¾ç—…å²</span>
      <span class="confirm-row-value">${diseasesHtml}</span>
    </div>
  `;

  // é–‹å•Ÿ modal
  const overlay = document.getElementById('confirmModal');
  overlay.classList.add('show');
}

// è¿”å›ä¿®æ”¹
document.getElementById('btnBack').addEventListener('click', () => {
  document.getElementById('confirmModal').classList.remove('show');
});

// é»èƒŒæ™¯é—œé–‰
document.getElementById('confirmModal').addEventListener('click', (e) => {
  if (e.target === document.getElementById('confirmModal')) {
    document.getElementById('confirmModal').classList.remove('show');
  }
});

// ç¢ºèªé€å‡º
document.getElementById('btnConfirm').addEventListener('click', async () => {
  const confirmBtn     = document.getElementById('btnConfirm');
  const confirmSpinner = document.getElementById('confirmSpinner');
  const confirmLabel   = document.getElementById('confirmLabel');
  confirmBtn.disabled  = true;
  confirmSpinner.style.display = 'inline-block';
  confirmLabel.textContent = 'é€å‡ºä¸­â€¦';

  const rawPhone = document.getElementById('phone').value.trim();

  // æ”¶é›†ç–¾ç—…å²
  const diseasesPayload = Array.from(document.querySelectorAll('input[name="disease"]:checked')).map(cb => {
    if (cb.id === 'diseaseJoint') return 'é—œç¯€å•é¡Œ: ' + (document.getElementById('jointDetail').value.trim() || '');
    if (cb.id === 'diseaseSpine') return 'è„Šæ¤å•é¡Œ: ' + (document.getElementById('spineDetail').value.trim() || '');
    if (cb.id === 'diseaseOther') return 'å…¶ä»–: '    + (document.getElementById('otherDetail').value.trim() || '');
    return cb.value;
  }).join('ã€');
  const payload = {
    action:            'submit',
    name:              document.getElementById('name').value.trim(),
    phone:             formatPhone(rawPhone),
    diseases:          diseasesPayload,
    line_user_id:      lineProfile.userId,
    line_display_name: lineProfile.displayName,
    line_picture_url:  lineProfile.pictureUrl || '',
    ref_by:            refBy,
    ref_name:          refName,
    source:            source,
    cid:               cid,
    submitted_at:      new Date().toISOString(),
  };

  console.log('ğŸ“¤ é€å‡ºè³‡æ–™ï¼š', payload);

  try {
    await fetch(WEBHOOK_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
    });
  } catch (err) {
    console.warn('Webhook å¤±æ•—ï¼š', err);
  }

  document.getElementById('confirmModal').classList.remove('show');
  showSuccess(payload);
});

// â”€â”€â”€ 7. Success screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showSuccess(data) {
  document.getElementById('formArea').style.display = 'none';
  const sa = document.getElementById('successArea');
  sa.style.display = 'block';

  const avatarHtml = data.line_picture_url
    ? `<img src="${data.line_picture_url}" class="line-avatar" style="margin-bottom:12px;" alt="">`
    : '';

  const rows = [
    ['å§“å',  data.name],
    ['æ‰‹æ©Ÿ',  data.phone],
    ['LINE åç¨±', data.line_display_name],
    ...(data.ref_name ? [['é‚€è«‹äºº', data.ref_name]] : []),
    ...(data.ref_by   ? [['é‚€è«‹ç¢¼', data.ref_by]]   : []),
    ...(data.source   ? [['ä¾†æº',   data.source]]    : []),
  ];

  document.getElementById('successData').innerHTML =
    (avatarHtml ? `<div style="text-align:center">${avatarHtml}</div>` : '') +
    rows.map(([k,v]) =>
      `<div class="success-data-row"><span>${k}</span><span>${escHtml(String(v))}</span></div>`
    ).join('');
}


// â”€â”€â”€ Disease checkboxes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(function initDiseases() {
  // é—œç¯€å•é¡Œ â†’ å±•é–‹è©³ç´°æ¬„
  document.getElementById('diseaseJoint').addEventListener('change', function() {
    var inp = document.getElementById('jointDetail');
    inp.style.display = this.checked ? 'block' : 'none';
    if (!this.checked) inp.value = '';
  });

  // è„Šæ¤å•é¡Œ â†’ å±•é–‹è©³ç´°æ¬„
  document.getElementById('diseaseSpine').addEventListener('change', function() {
    var inp = document.getElementById('spineDetail');
    inp.style.display = this.checked ? 'block' : 'none';
    if (!this.checked) inp.value = '';
  });

  // å…¶ä»– â†’ å±•é–‹è©³ç´°æ¬„
  document.getElementById('diseaseOther').addEventListener('change', function() {
    var inp = document.getElementById('otherDetail');
    inp.style.display = this.checked ? 'block' : 'none';
    if (!this.checked) inp.value = '';
  });

  // "ç„¡" â†’ æ¸…é™¤æ‰€æœ‰å…¶ä»–é¸é …
  document.getElementById('diseaseNone').addEventListener('change', function() {
    if (!this.checked) return;
    document.querySelectorAll('input[name="disease"]').forEach(function(c) {
      if (c.id === 'diseaseNone') return;
      c.checked = false;
      var lbl = c.closest('.disease-item');
      if (lbl) lbl.classList.remove('selected');
    });
    ['jointDetail','spineDetail','otherDetail'].forEach(function(id) {
      var el = document.getElementById(id);
      if (el) { el.style.display = 'none'; el.value = ''; }
    });
  });

  // å…¶ä»–é¸é … â†’ å–æ¶ˆã€Œç„¡ã€
  document.querySelectorAll('input[name="disease"]').forEach(function(cb) {
    if (cb.id === 'diseaseNone') return;
    cb.addEventListener('change', function() {
      if (this.checked) {
        document.getElementById('diseaseNone').checked = false;
        var noLbl = document.getElementById('noDiseaseLabel');
        if (noLbl) noLbl.classList.remove('selected');
      }
    });
  });
})();

// â”€â”€â”€ Util â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function escHtml(str) {
  return str.replace(/[&<>"']/g, c =>
    ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
}

// é›»è©±æ ¼å¼åŒ–ï¼š0912345678 â†’ 0912-345-678ï¼ˆç¬¦åˆç¸½è¡¨ K æ¬„æ ¼å¼ï¼‰
function formatPhone(raw) {
  const digits = raw.replace(/\D/g, '');        // åªå–æ•¸å­—
  if (digits.length !== 10) return raw;          // ä¸è¶³ 10 ç¢¼ä¸è½‰
  return `${digits.slice(0,4)}-${digits.slice(4,7)}-${digits.slice(7,10)}`;
}
</script>

</body>
</html>
